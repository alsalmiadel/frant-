var w=Object.defineProperty;var p=(l,e,t)=>e in l?w(l,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[e]=t;var h=(l,e,t)=>p(l,typeof e!="symbol"?e+"":e,t);import{a as m,S as n,z as o,s as c}from"./index-mfTr1OfE.js";class y{constructor(){h(this,"baseURL","https://smartstartai-backend-production.up.railway.app");h(this,"requestQueue",new Map)}async makeRequest(e,t={}){const r=await this.getClientId();if(!m.isAllowed(r))throw new Error("تم تجاوز الحد المسموح من الطلبات. يرجى المحاولة لاحقاً.");const a={"Content-Type":"application/json","X-Client-Version":"1.0.0","X-Request-ID":n.generateSessionToken(),...t.headers},i=await this.getAuthToken();i&&(a.Authorization=`Bearer ${i}`);const s=await fetch(`${this.baseURL}${e}`,{...t,headers:a});if(!s.ok){const d=await s.json().catch(()=>({}));throw new Error(d.detail||`HTTP error! status: ${s.status}`)}return await s.json()}async getClientId(){let e=localStorage.getItem("client_id");return e||(e=n.generateSessionToken(),localStorage.setItem("client_id",e)),e}async voiceChat(e){try{if(e.audioFile.size>10*1024*1024)throw new Error("حجم الملف الصوتي كبير جداً");if(!["audio/webm","audio/webm;codecs=opus","audio/wav","audio/mp3","audio/m4a"].includes(e.audioFile.type))throw new Error("نوع الملف الصوتي غير مدعوم");const r=new FormData;r.append("audioFile",e.audioFile),e.sessionId&&r.append("session_id",e.sessionId);const a=await this.getAuthToken(),i={"X-Client-Version":"1.0.0","X-Request-ID":n.generateSessionToken()};a&&(i.Authorization=`Bearer ${a}`);const s=await fetch(`${this.baseURL}/stt`,{method:"POST",headers:i,body:r});if(!s.ok){const u=await s.json().catch(()=>({}));throw new Error(u.detail||`HTTP error! status: ${s.status}`)}const d=await s.json();return this.logActivity("voice_chat",{sessionId:e.sessionId}),{success:!0,user_text:d.text||"",assistant_text:"تم تحويل الصوت بنجاح",session_id:e.sessionId||"default",model_used:"whisper",processing_time:0}}catch(t){throw console.error("Voice chat error:",t),o.error("خطأ في المحادثة الصوتية"),t}}async textChat(e){try{const t=n.sanitizeInput(e.message),r=await fetch(`${this.baseURL}/chat`,{method:"POST",headers:{"Content-Type":"application/json","X-Client-Version":"1.0.0"},body:JSON.stringify({text:t})});if(!r.ok){const s=await r.json().catch(()=>({}));throw new Error(s.detail||`HTTP error! status: ${r.status}`)}const i={success:!0,response:(await r.json()).text||"عذراً، لم أتمكن من فهم طلبك",session_id:e.sessionId||"default",model_used:"hoor",processing_time:0};return this.logActivity("text_chat",{sessionId:e.sessionId}),i}catch(t){throw console.error("Text chat error:",t),o.error("خطأ في المحادثة النصية"),t}}async generateBusinessPlan(e){try{this.validateBusinessPlanRequest(e);const t=await fetch("/api/brain",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:`أريد دراسة جدوى لمشروع ${e.projectName} في قطاع ${e.industry}`,context:{sector:e.industry,city:e.location,capex:e.initialInvestment,price_avg:e.revenueProjections[0]/12/(e.initialInvestment*.1),customers_month:Math.round(e.revenueProjections[0]/12/50),cogs_ratio:e.variableCosts/e.revenueProjections[0],opex_monthly:e.fixedCosts/12,months:60,projectName:e.projectName}})});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const r=await t.json();return this.logActivity("business_plan_generated",{projectName:e.projectName}),{success:!0,plan_id:`plan_${Date.now()}`,files:r.files,generated_at:r.timestamp,summary:r.summary,analysis:r.analysis,financials:r.financials,bankability:r.bankability}}catch(t){throw console.error("Business plan generation error:",t),o.error("خطأ في إنتاج دراسة الجدوى"),t}}validateBusinessPlanRequest(e){const t=[];if((!e.projectName||e.projectName.trim().length<3)&&t.push("اسم المشروع يجب أن يكون 3 أحرف على الأقل"),e.industry||t.push("نوع المشروع مطلوب"),(!e.description||e.description.trim().length<10)&&t.push("وصف المشروع يجب أن يكون 10 أحرف على الأقل"),e.initialInvestment<1e4&&t.push("الاستثمار المبدئي يجب أن يكون 10,000 ريال على الأقل"),e.initialInvestment>1e8&&t.push("الاستثمار المبدئي كبير جداً"),t.length>0)throw new Error(t.join(", "))}async downloadFile(e,t){try{const r=await fetch(`${this.baseURL}/download/${e}/${t}`,{headers:{Authorization:`Bearer ${await this.getAuthToken()}`}});if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);const a=await r.blob(),i=window.URL.createObjectURL(a),s=document.createElement("a");s.href=i,s.download=`${e}_${t}.${t==="excel"?"xlsx":"pdf"}`,document.body.appendChild(s),s.click(),window.URL.revokeObjectURL(i),document.body.removeChild(s),o.success("تم تحميل الملف بنجاح"),this.logActivity("file_downloaded",{planId:e,fileType:t})}catch(r){throw console.error("Download error:",r),o.error("خطأ في تحميل الملف"),r}}async getStats(){try{return await(await fetch(`${this.baseURL}/stats`)).json()}catch(e){return console.error("Stats error:",e),null}}async getModelsStatus(){try{return await(await fetch(`${this.baseURL}/models/status`)).json()}catch(e){return console.error("Models status error:",e),null}}async getAuthToken(){const{data:{session:e}}=await c.auth.getSession();return(e==null?void 0:e.access_token)||""}async saveProject(e){try{const t={...e,title:n.sanitizeInput(e.title),description:n.sanitizeInput(e.description)},{data:r,error:a}=await c.from("projects").insert([t]).select().single();if(a)throw a;return o.success("تم حفظ المشروع بنجاح"),this.logActivity("project_saved",{projectId:r.id}),r}catch(t){throw console.error("Save project error:",t),o.error("خطأ في حفظ المشروع"),t}}async getUserProjects(e){try{const{data:t,error:r}=await c.from("projects").select("*").eq("user_id",e).order("created_at",{ascending:!1});if(r)throw r;return t||[]}catch(t){return console.error("Get projects error:",t),[]}}async updateProject(e,t){try{const r={...t,title:t.title?n.sanitizeInput(t.title):void 0,description:t.description?n.sanitizeInput(t.description):void 0,updated_at:new Date().toISOString()},{data:a,error:i}=await c.from("projects").update(r).eq("id",e).select().single();if(i)throw i;return o.success("تم تحديث المشروع بنجاح"),this.logActivity("project_updated",{projectId:e}),a}catch(r){throw console.error("Update project error:",r),o.error("خطأ في تحديث المشروع"),r}}async deleteProject(e){try{const{error:t}=await c.from("projects").delete().eq("id",e);if(t)throw t;o.success("تم حذف المشروع بنجاح"),this.logActivity("project_deleted",{projectId:e})}catch(t){throw console.error("Delete project error:",t),o.error("خطأ في حذف المشروع"),t}}async logActivity(e,t){try{const{data:{user:r}}=await c.auth.getUser();r&&await c.from("audit_logs").insert([{user_id:r.id,action:e,table_name:"user_activity",new_data:{...t,timestamp:new Date().toISOString(),user_agent:navigator.userAgent}}])}catch(r){console.warn("Failed to log activity:",r)}}async refreshSession(){try{const{data:e,error:t}=await c.auth.refreshSession();if(t)throw t;return e.session}catch(e){return console.error("Session refresh error:",e),null}}clearSensitiveData(){n.clearSensitiveData(this),["auth_token","session_data","user_cache"].forEach(t=>{localStorage.removeItem(t),sessionStorage.removeItem(t)})}async healthCheck(){try{return await(await fetch(`${this.baseURL}/health`,{method:"GET",signal:AbortSignal.timeout(3e3)})).json()}catch(e){return console.error("Health check failed:",e),{status:"unhealthy"}}}handleError(e,t){console.error(`API Error in ${t}:`,e),e.message.includes("network")?o.error("مشكلة في الاتصال بالإنترنت"):e.message.includes("unauthorized")?o.error("انتهت صلاحية الجلسة، يرجى تسجيل الدخول مرة أخرى"):o.error("حدث خطأ غير متوقع")}async reportError(e,t){try{await this.makeRequest("/errors/report",{method:"POST",body:JSON.stringify({error:e.message,context:t,timestamp:new Date().toISOString(),userAgent:navigator.userAgent,url:window.location.href})})}catch(r){console.warn("Failed to report error:",r)}}}const g=new y;window.addEventListener("beforeunload",()=>{g.clearSensitiveData()});export{g as a};
